#include <iostream>
#include <sstream>
#include <algorithm>
#include <iomanip>

#include "defs.h"

void bind_key(const unsigned char key[16], const unsigned char file_id[20], unsigned char dst[16]);
void decrypt_main(const unsigned char key_basis[16], unsigned char dst[16]);
unsigned int process(char a1, unsigned int a2, unsigned int a3, unsigned int a4, unsigned int a5);

template <typename A>
unsigned char _bittest(A *a, int b)
{
    auto const bits{reinterpret_cast<unsigned char const *>(a)};
    auto const value{bits[b >> 3]};
    auto const mask{(unsigned char)(1 << (b & 7))};
    return (value & mask) != 0;
}

/* pick 32-bit unsigned integer in little endian order */
static unsigned int U8TOU32(const unsigned char *p) {
    return (((unsigned int)(p[0] & 0xff)) | ((unsigned int)(p[1] & 0xff) << 8) |
                    ((unsigned int)(p[2] & 0xff) << 16) | ((unsigned int)(p[3] & 0xff) << 24));
}

static int char2int(char input)
{
    if (input >= '0' && input <= '9')
        return input - '0';
    if (input >= 'A' && input <= 'F')
        return input - 'A' + 10;
    if (input >= 'a' && input <= 'f')
        return input - 'a' + 10;
    throw std::invalid_argument("Invalid input string");
}

static void hex2bin(const char *src, char *target)
{
    while (*src && src[1])
    {
        *(target++) = char2int(*src) * 16 + char2int(src[1]);
        src += 2;
    }
}

static const unsigned int playIntentKey[0x300] = {
    0xAB25CD16, 0xCE5F42AE, 0x975D0D15, 0x85EA718D, 0x077F942A, 0x193A8658,
    0x52CA63B6, 0xD45F8653, 0xE61A7882, 0x44820D68, 0x3FE697D2, 0x1F3AC9FD,
    0x42743F96, 0x725C7692, 0xD5C45462, 0xE77F4690, 0x45E6DB77, 0x57A1CDA5,
    0xD936F042, 0x12C6CDA0, 0xDBC49807, 0xD7292270, 0xE3E3CBB6, 0x474BA985,
    0x80DB86E3, 0x0270A980, 0x142B9BAF, 0x95C0BE4C, 0x844E22C3, 0x4D4BED2A,
    0x48B07794, 0xA06D99BF, 0x03D5778E, 0x159069BD, 0x97258C5A, 0x85B2F0D2,
    0x0748136F, 0x88409896, 0xA1D267CD, 0x053A459D, 0x5CF767C8, 0x755CCCB2,
    0xCD19EEDD, 0x3081CCAD, 0x423CBEDB, 0xC3D1E178, 0x1CF57B71, 0x5E5C35D7,
    0x76C19AC0, 0xCE7EBCEC, 0x31E69ABB, 0x61CED1B7, 0xC536AF87, 0xFEC68CE5,
    0x3559369C, 0xBE2898CC, 0xCFE38AFA, 0x49A1D08F, 0x63339FC6, 0xDCF1E55B,
    0xD35626DB, 0x5E92EFD9, 0x704DE208, 0x89DFB13F, 0x52DD7BA6, 0x8C6D5904,
    0x062B9E98, 0xFC8FE018, 0x764E25AD, 0x8FDFF4E4, 0xF347D2B4, 0x4B04F4DF,
    0x8DD22712, 0xEC39BBF8, 0xFDF4AE27, 0x77B2F3BC, 0x9144C2F3, 0x0B030887,
    0x4C69C2EE, 0x64CF27D7, 0xBC8C4A02, 0xFF597C35, 0x97450698, 0xBA7E7C30,
    0x3C139ECD, 0x4DCE90FC, 0xA45F48DA, 0xBDF11811, 0xCFAC0A40, 0x51412CDD,
    0xBBE34A3F, 0x53CED4A1, 0x2C05D154, 0xC3F15BB6, 0xBF55E61F, 0x39142BB4,
    0x7A7AE61A, 0x8C35D849, 0xEA9D6D2F, 0x43C10727, 0xC55629C4, 0xE88F9F5D,
    0x807B29BF, 0x7BDFB429, 0x8D9AA658, 0xEC023B3E, 0xFDBD2D6C, 0xC6BAF7D3,
    0x004AD531, 0x81DFF7CE, 0x939AE9FC, 0xF2027EE3, 0xED67094C, 0x26F6E6AA,
    0xA88C0947, 0xBA46FB76, 0x8344C5DC, 0xBCD4A33A, 0xF3674CF1, 0x2CF72A4F,
    0xAE8C4CEC, 0xA9F0D756, 0xBBABC984, 0x3D40EC21, 0x2BCE5099, 0xF4CC1B00,
    0x2E5BF85D, 0xAFF11AFB, 0xC1AC0D29, 0x0312C78F, 0x31CE943E, 0x550809D7,
    0xD69D2C74, 0x4DEE0B39, 0xB155E909, 0xC310DB38, 0x44A5FDD5, 0x3333624D,
    0x749A1CB3, 0xEE586247, 0x07EA317F, 0x81A87713, 0x0A77D943, 0x22DD3E2C,
    0x5C6D1B8A, 0xDE023E27, 0xEFBD3056, 0x094EFF8D, 0xAAE23051, 0xA14671D1,
    0x1B04B766, 0x7BFF2E66, 0xDF670C36, 0x0F4F4332, 0x3288B8CB, 0xAC46FE5F,
    0xA2AB3FE0, 0x1C698574, 0x35FB54AB, 0xAFB99A40, 0x3888FC70, 0x9BF0DA3F,
    0xA8AB8384, 0xA4100DEE, 0x1DCE5383, 0x376022BA, 0xB11E684E, 0xF28522B5,
    0xB3AC1013, 0xAA105193, 0x0D782F63, 0x3D60665F, 0x6099DBF8, 0xF885665A,
    0xF3E9F0C3, 0x4A7AA8A1, 0x640C77D8, 0x25336536, 0x669A1F9C, 0x785511CB,
    0xF9EA3468, 0xE87798E0, 0x6A0CBB7D, 0x657145E7, 0xDF2F8B7B, 0x209645E2,
    0xE9941048, 0xFB4F0277, 0xE9DC66EE, 0x6B71898C, 0xA50166E9, 0x26968986,
    0x38517BB5, 0x9BB95985, 0x921D9B05, 0xEB4134FD, 0x94AB42C9, 0xA66634F8,
    0x27FB5795, 0x39B649C4, 0x981DDEAA, 0xA9D8D0D8, 0x2B6DF376, 0x961010D8,
    0xA7CB0306, 0x296025A3, 0x62F00301, 0x9982ACB8, 0xD3128A16, 0x54A7ACB3,
    0x66629EE2, 0xE7F7C17F, 0x2AC4F3B2, 0x377F9CF7, 0x9AE77AC7, 0xD4775825,
    0x560C7AC2, 0x67C76CF0, 0xE95C8F8D, 0xD7E9F405, 0xFB23699E, 0xC4213404,
    0xF4096B01, 0x577148D0, 0x692C3AFF, 0x129648CB, 0x0123AD43, 0x82B8CFE0,
    0x9473C20F, 0xA62EB43D, 0x6F2C7EA4, 0xB093390A, 0xC8F89DF4, 0x02887B51,
    0x841D9DEE, 0x95D8901D, 0x176DB2BA, 0x50FD9018, 0xB1F80719, 0x0888BEF6,
    0x221A8E2D, 0x85826BFD, 0xB56AA2F9, 0x18D280C9, 0x52625E27, 0x48C69FA7,
    0xC284E53B, 0x237F5C3C, 0x9D3DA1D1, 0xDEA45C37, 0x5862A1CB, 0x4EC6E34C,
    0xB22EC11B, 0xC3E9B34A, 0xDD7B8281, 0x7F0EB345, 0xE0092A45, 0x59C76FDA,
    0x502BB15A, 0xC9E9F6EF, 0xE37BC626, 0x5D3A0BBB, 0x80738153, 0xB05BB850,
    0xF0960868, 0x51907F69, 0xCB4EC4FD, 0x0CB57F64, 0x8673C4F8, 0xA005942F,
    0x8E92F8A7, 0x10281B44, 0x21E30D73, 0x12B5C308, 0x0E1A4D72, 0x87D89307,
    0xA16A623E, 0xF7FB1A1C, 0x118CE953, 0x4B1CC6B1, 0xCCB1E94E, 0xDE6CDB7C,
    0xA76AA5E3, 0xCAA41B7C, 0x178D2CF8, 0x3AC6A290, 0x4C8194BF, 0xCE16B75C,
    0xDFD1A98B, 0x3E393E71, 0x4FF430A0, 0x18F1FB06, 0x5281D864, 0xD416FB01,
    0xCF7B856B, 0x090B62C8, 0x3F9E0C80, 0x792DE9DD, 0xFAC30C7A, 0x53E6A672,
    0xD57BC910, 0xE736BB3E, 0x90A0C90A, 0x68D7C5BD, 0x7A92B7EC, 0xFC27DA89,
    0x0DE2CCB8, 0x8F77EF55, 0x1070747C, 0x47031E33, 0x8092FB91, 0x9A24CAC8,
    0x13E3105C, 0x371C85F5, 0xB8B1A892, 0xA73F0D0A, 0x28D42FA7, 0x81F7C99F,
    0x038CEC3C, 0x1547DE6B, 0x56AE98D1, 0x856A6580, 0xA8A3DB19, 0x408F657B,
    0x3BF3EFE4, 0xBD891281, 0x3E8197A9, 0xC016BA46, 0xAEA41EBD, 0xC835EDF5,
    0x41F43389, 0x3D58BDF3, 0xFD193384, 0xF87DBDEE, 0xC17B8854, 0xB008ECCC,
    0xC99ABC03, 0x43590198, 0x84BFBBFE, 0xFE7E0193, 0xF4E24313, 0x6EA088A7,
    0x6A051311, 0x3302DD78, 0x6C92BAD5, 0x86248A0D, 0xFFE2CFA1, 0xF6471121,
    0x700556B6, 0x899725ED, 0x03556B82, 0x268EE11A, 0xEF8CAB81, 0x1F74E27D,
    0xF7ABDF30, 0x716A24C4, 0xB2D0DF2B, 0x2C8F24BF, 0x4620F3F7, 0x9CB1ABD4,
    0x9816363E, 0x373C0033, 0xB8D122D0, 0xCA8C14FE, 0x2DF3F2CE, 0x4785C205,
    0x9E1679E3, 0xB7A8491A, 0x31668EAE, 0xBA35F0DE, 0xCBF0E30D, 0x4D8605AA,
    0x8715E308, 0x9F7B47F1, 0xF7386A1D, 0x5AA047EC, 0x74321723, 0x85ED0952,
    0x4EEAD3B8, 0x3D783830, 0xE6E245FC, 0xF89D382B, 0x7A325AC8, 0x8BED4CF7,
    0xEF552AC6, 0xE5B96C47, 0x1F4949A4, 0xE847140B, 0xFA02063A, 0x7B9728D7,
    0xB5270634, 0x36BC28D2, 0x25498D49, 0x88B16B19, 0xB899A215, 0xB3FE2C7F,
    0x7CFBF6E5, 0xB68BD443, 0xED1E7DFA, 0x26AE5B58, 0xA8437DF5, 0xB9FE7024,
    0xDD37E5BC, 0x7523701E, 0xB7F0A252, 0x16583738, 0x28132966, 0xA9A84C03,
    0xBB633E32, 0x64CD4BFE, 0x2B85C547, 0x6515A2A5, 0xE6AAC542, 0x2977F775,
    0xAB0D1A12, 0xE49CF770, 0x66321A0D, 0x54BF7E85, 0xD654A122, 0xE80F9350,
    0xF9CA857F, 0xA334934B, 0x042F0A4C, 0x7DED4FE0, 0x56244C93, 0xD7B96F30,
    0xE974615F, 0x2ADB1BC5, 0xA499615A, 0x9326C5D2, 0x14BBE86F, 0x75B65F6F,
    0xEF74A504, 0x12AE1A9D, 0x94433D3A, 0xA5FE2F68, 0x9C6270E9, 0x1620B67D,
    0x2FB285B4, 0x18AE5E41, 0x32402D79, 0xABFE730D, 0xA762FD77, 0x1C20FA22,
    0x1785848C, 0x6F42A6B7, 0xD2AA8487, 0xEC3C53BE, 0xAD63411C, 0xA3C7829C,
    0x1D85C831, 0x5EEC8297, 0x70A774C6, 0xD40F5295, 0x03F78991, 0x4431D9AA,
    0x741A10A6, 0x46BF816E, 0x605150A5, 0xDA0F963A, 0xF3A16571, 0x2D3142CF,
    0x4596A7B8, 0x9D53C9E4, 0x00BBA7B3, 0x61B61EB4, 0xDB746448, 0x1CDB1EAF,
    0x4B96EB5D, 0x8CFDA5C4, 0x9EB897F2, 0x022075C2, 0x3208ACBE, 0x95708A8E,
    0x34965482, 0x4CFBB96C, 0x8E6273D2, 0xA01D6601, 0x21B2889E, 0x5B4265FC,
    0xDCD78899, 0xCB64ED11, 0x2ECCCAE0, 0xA61DA9A6, 0x27B2CC43, 0x396DBE71,
    0x5CA7340A, 0x9339DDC1, 0xCCC9BB1F, 0x4E5EDDBC, 0x6019CFEB, 0xD9D8157F,
    0x62A777AF, 0x5E0C0219, 0xD2C9FEC4, 0xCE2E892E, 0x4FC3ABCB, 0x617E9DF9,
    0x0AE8ABC6, 0xF976103D, 0xC273DAA4, 0xD42ECCD2, 0xCF93573C, 0x677EE19E,
    0x8AB85737, 0x22A3E199, 0xFADADE4C, 0x7C7000E9, 0x8E2AF318, 0x5728BD7E,
    0x90B89ADC, 0xA2738D0A, 0x2408AFA8, 0xFC3FAC5A, 0x942B36BC, 0x8F8FC126,
    0x277B4B88, 0x4AB4C121, 0xABAF3822, 0x023FEFFF, 0x1BD1BF36, 0x959004CB,
    0xCF1FE229, 0x50B504C6, 0x4C198F30, 0xC0D78BDB, 0xBC3C1644, 0x450B7874,
    0xBEC9BE09, 0xD85B8D40, 0x5219D2D4, 0x63D4C503, 0xC23C59E9, 0xBDA0E453,
    0x558C6EB5, 0xC02E8C17, 0xF016C313, 0x537EA0E3, 0x49E2E263, 0xC3A127F8,
    0x0507E25E, 0x7EC627F3, 0x90811A21, 0xAA12E958, 0x7CB85A21, 0x619E1837,
    0xECDAE135, 0x066CB06D, 0x802AF601, 0x99BCC538, 0x137B0ACD, 0x02086F45,
    0x436F29AB, 0x0C6CF411, 0x1E27E640, 0x818FC410, 0xD94CE63B, 0xF1B24B25,
    0x3319058B, 0xACD74B1F, 0xBE923D4E, 0xD8240C85, 0xA121D6EC, 0xDAB1B449,
    0xF3171933, 0x4AD43B5E, 0xAE3C192E, 0xDE24502A, 0x015DC5C3, 0x82F2E860,
    0xB8E8F4A1, 0x3A7E173E, 0x4C39096D, 0xAFA0E73C, 0xDF891E39, 0x6AC5E737,
    0x7780907D, 0x72E51AE6, 0xF47A3D83, 0x4D9DD77B, 0xCF32FA19, 0x08C2D776,
    0x8A57FA13, 0x78E55E8B, 0x7449E8F5, 0x0C357357, 0x2F6EE8F0, 0xC75A7352,
    0x0A27A585, 0x688F3A6B, 0x7A4A2C9A, 0xFBDF4F37, 0x0D9A4165, 0x472A1EC3,
    0xC8BF4160, 0xA0F63E13, 0x38E1C875, 0x7BAEFAA8, 0xFD441D45, 0x36D3FAA3,
    0xB8691D40, 0xCA240F6F, 0xB8B173E7, 0x3A469684, 0x4C0188B2, 0x3CD43E48,
    0x3838C8B2, 0xB9CDEB4F, 0xA85B4FC6, 0xC1ED1EFE, 0x3BAB6492, 0x753B41F0,
    0xF6D0648D, 0x088B56BC, 0xD1892122, 0xA9C01DD5, 0x2B554072, 0x64E51DD0,
    0x94CD54CC, 0xF835329C, 0x09F024CA, 0x6857B9B0, 0x7A12ABDF, 0x6AE56175,
    0x6649EBDE, 0xFE357640, 0xF99A00AA, 0x0654A9EF, 0x69BC87BF, 0xA34C651D,
    0x24E187BA, 0x369C79E8, 0xFF9A444F, 0x392A21AD, 0x2F8E632D, 0x92F640FD,
    0xC2DE77F9, 0x264655C8, 0x562E8CC5, 0xB9966A94, 0xF76353DE, 0x71219972,
    0xAAB176D0, 0xC4434607, 0x27AB23D7, 0x7F684602, 0x97CDAAEC, 0xEF8ACD17,
    0x52F2AAE7, 0xB3ED21E7, 0x2DAB677C, 0x473D36B3, 0x80CD1411, 0xC1076429,
    0xF0EF9B26, 0x545778F5, 0x843FAFF1, 0xE7A78DC1, 0x7076EFF1, 0x5F045468,
    0xE0997705, 0xF2546934, 0x6C12AEC9, 0xAD79692F, 0x10E146FE, 0x1D9BF044,
    0xC86C75DD, 0xE1FE4514, 0xF3B93743, 0x754E59E0, 0xAEDE373D, 0x289C7CD2,
    0x1F00BE52, 0x98BF03E7, 0xB250D31E, 0x1CF2F080, 0xB4DE7AE2, 0xB043054C,
    0x0EAA9A32, 0x20658C61, 0xA1FAAEFE, 0xB3B5A12D, 0x5548D1F0, 0x6EDAA127,
    0xC7FE3B20, 0x2665D006, 0x21CA5A6F, 0xB9B5E4D1, 0xDCEF5A6A, 0x5E847D07,
    0x703F6F36, 0xC6D02714, 0xE061F64B, 0x615A7B72, 0xE2EF9E0F, 0xDE542879,
    0x763FB2DB, 0x4E76AF8E, 0xD00BD22B, 0xE1C6C459, 0x1B56A1B7, 0xE4546C1E,
    0xF60F5E4C, 0x77A480E9, 0x4FDB7D9C, 0xE7C707FE, 0x0B007D97, 0xA2EC07F9,
    0x9E509263, 0xB00B8491, 0xA0DE3A27, 0x8F6B9E9F, 0x1100C13C, 0x22BBB36B,
    0xA450D608, 0xB60BC836, 0x14735D1C, 0x0FD7E786, 0x4967C4E4, 0x12658F4A,
    0x2BF75E82, 0xA5B5A416, 0xDF458174, 0x15D82B2B, 0x4F680889, 0x68F9D7C0,
    0xCC61B590, 0xDE1CA7BE, 0xA71A7225, 0x9D7EB3A5, 0x3F11E469, 0x50CCD697,
    0xD261F934, 0xE41CEB63, 0x2583A5C9, 0x3DE90AB3, 0xDD0ED4A8, 0x4076B277,
    0x705EE973, 0xD3C6C743, 0x0D56A4A1, 0x8EEBC73E, 0x7D792BB6, 0x970AFAED,
    0x10C94081, 0x71C3B782, 0xD52B9551, 0x2CE8B77D, 0x454E1C66, 0x86B4D6CD,
    0x986FC8FB, 0x122E0E90, 0x5394C8F6, 0xCD530E8B, 0x2E4D858B, 0x6E87D5A4,
    0x9E700CA0, 0x01D7EA70, 0x31C0216C, 0x54F99705, 0xCEB7DC99, 0xC51C1E1A,
    0x3EDA63AE, 0x9FD4DAAF, 0x033CB87E, 0x5AF9DAAA, 0x6CB4CCD8, 0xCB1C61BE,
};
